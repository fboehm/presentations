---
title: "Enhancing QTL mapping with allelic series inferences"
author: "Fred Boehm"
institute: "U. Mass. Medical School"
date: "October 14, 2020 (updated: `r Sys.Date()`)"
bibliography: ../research.bib
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true  
      countIncrementalSlides: false
---

```{r setup2, include=FALSE, dev="CairoPNG"}
knitr::opts_chunk$set(dev="CairoPNG")
```



```{r, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
#PATH_TO_DDATA <- "~/work/research/qtl2tb/analysis/data/derived_data"
PATH_TO_DDATA <- "~/qtl2tb/analysis/data/derived_data" #for use on ghpcc
library(magrittr)
nc <- 16
```

# DO QTL mapping study

- 763 Diversity Outbred mice
- GigaMUGA genotyping array
- Phenotypes: Lung CFU, Spleen CFU, peak weight, weight at death, percent normal lung
- Covariates: Sex, Batch, Dose



---

# QTL mapping results in DO

```{r}
load(file.path(PATH_TO_DDATA, "fda_qtl_input.Rdata"))
fn <- file.path(PATH_TO_DDATA, "scan1out_do-clinical.rds")
qtl <- readRDS(fn)
qtl <- do.call("cbind", qtl)
ls_ratio <- qtl2::find_peaks(qtl[, ncol(qtl), drop = FALSE], map, threshold = 6, peakdrop = 1.5, prob = 0.95) %>% # get only one trait's peaks
  tibble::as_tibble() %>%
  dplyr::mutate(trait = "lung_spleen_ratio")
peaks <- qtl2::find_peaks(qtl[ , - ncol(qtl)], map, threshold = 6, peakdrop = 1.5, prob = 0.95) %>%# get peaks for other traits
  tibble::as_tibble() %>%
  dplyr::mutate(trait = lodcolumn) %>%
  dplyr::bind_rows(ls_ratio) %>%
  dplyr::select(trait, chr, pos, lod, ci_lo, ci_hi, - lodcolumn)
peaks %>%
    gt::gt() %>%
    gt::fmt_number(
    columns = dplyr::vars(lod, pos, ci_lo, ci_hi),
    decimals = 1
  )
```

---

# Lung CFU on Chr 17

```{r}
afn <- file.path(PATH_TO_DDATA, "do_scan1blup_lung_Chr17.rds")
if (!file.exists(afn)){
  s1b <- qtl2::scan1blup(probs[, 17], 
                       pheno_rz[ , 1, drop = FALSE], 
                       kinship = K$`17`, 
                       addcovar = covar, 
                       cores = nc)
  saveRDS(s1b, afn)
} else {s1b <- readRDS(afn)}
```


```{r}
qtl2::plot_coefCC(s1b, map, scan1_output = qtl[, 1, drop = FALSE])
```


---

# Spleen CFU on Chr 17

```{r}
bfn <- file.path(PATH_TO_DDATA, "do_scan1blup_spleen_Chr17.rds")
if (!file.exists(bfn)){
  s1b <- qtl2::scan1blup(probs[, 17], 
                       pheno_rz[ , 2, drop = FALSE], 
                       kinship = K$`17`, 
                       addcovar = covar, 
                       cores = nc)
  saveRDS(s1b, bfn)
} else {s1b <- readRDS(bfn)}
```


```{r}
qtl2::plot_coefCC(s1b, map, scan1_output = qtl[, 2, drop = FALSE])
```

---

# Spleen CFU on Chr 1

```{r}
cfn <- file.path(PATH_TO_DDATA, "do_scan1blup_spleen_Chr1.rds")
if (!file.exists(cfn)){
  s1b <- qtl2::scan1blup(probs[, 1], 
                       pheno_rz[ , 2, drop = FALSE], 
                       kinship = K$`1`, 
                       addcovar = covar, 
                       cores = nc)
  saveRDS(s1b, cfn)
} else {s1b <- readRDS(cfn)}
```


```{r}
qtl2::plot_coefCC(s1b, map, scan1_output = qtl[, 2, drop = FALSE])
```



---

# Spleen CFU on Chr 11

```{r}
bfn <- file.path(PATH_TO_DDATA, "do_scan1blup_spleen_Chr11.rds")
if (!file.exists(bfn)){
  s1b <- qtl2::scan1blup(probs[, 11], 
                       pheno_rz[ , 2, drop = FALSE], 
                       kinship = K$`11`, 
                       addcovar = covar, 
                       cores = nc)
  saveRDS(s1b, bfn)
} else {s1b <- readRDS(bfn)}
```


```{r}
qtl2::plot_coefCC(s1b, map, scan1_output = qtl[, 2, drop = FALSE])
```


---

# Spleen CFU on Chr 15

```{r}
bfn <- file.path(PATH_TO_DDATA, "do_scan1blup_spleen_Chr15.rds")
if (!file.exists(bfn)){
  s1b <- qtl2::scan1blup(probs[, 15], 
                       pheno_rz[ , 2, drop = FALSE], 
                       kinship = K$`15`, 
                       addcovar = covar, 
                       cores = nc)
  saveRDS(s1b, bfn)
} else {s1b <- readRDS(bfn)}
```


```{r}
qtl2::plot_coefCC(s1b, map, scan1_output = qtl[, 2, drop = FALSE])
```



---


```{r, scan1-cc}
load(file.path(PATH_TO_DDATA, "reduced_map_qtl2_mapping_objects.Rdata"))
cc_kinship <- qtl2::calc_kinship(genoprobs.1, "loco")
cc_pheno <- read.csv(file.path(PATH_TO_DDATA, "batch_corrected_phenos_summarized_05OCT2019_v4.csv"))[, -c(1:7)]
rownames(cc_pheno) <- read.csv(file.path(PATH_TO_DDATA, "batch_corrected_phenos_summarized_05OCT2019_v4.csv"))[, 1] %>% paste0("cs")

cc_s1 <- qtl2::scan1(genoprobs = genoprobs.1, 
                     pheno = cc_pheno, 
                     kinship = cc_kinship, 
                     addcovar = addcovar, 
                     reml = TRUE
                     )
```



# Clinical QTL in CC (Clare & colleagues)

```{r tnseq-timbr}
t_out <- readRDS(file.path(PATH_TO_DDATA, "cc-timbr-clinical-M1-with-tnseq-reduced-peaks-cis-perms-pvalues.rds")) 
t_out %>%
  dplyr::select(lodcolumn, chr, pos, lod, cc_peak_bayes_lower, cc_peak_bayes_upper) %>%
  dplyr::rename(trait = lodcolumn, lower = cc_peak_bayes_lower, upper = cc_peak_bayes_upper) %>%
  gt::gt() %>%
    gt::fmt_number(
    columns = dplyr::vars(lod, pos, lower, upper),
    decimals = 1
  )
```

---

# Allele effects at Chr 7 lung CFU CC QTL

```{r}
left <- names(map.1[[7]])[1]
right <- names(map.1[[7]])[min(which(map.1[[7]] > 25))] 
s1b_lungcfu_chr7 <- qtl2::scan1blup(genoprobs = genoprobs.1[, 7], 
                pheno = cc_pheno[, 1, drop = FALSE], 
                kinship = cc_kinship[[7]], 
                addcovar = addcovar, 
                se = TRUE
                )
s1 <- cc_s1[which(rownames(cc_s1) == left):which(rownames(cc_s1) == right), 1, drop = FALSE]
b1 <- s1b_lungcfu_chr7[which(rownames(s1b_lungcfu_chr7) == left):which(rownames(s1b_lungcfu_chr7) == right), ]
qtl2::plot_coefCC(b1, map = map.1, scan1_output = s1)
```

---

# Reduced scans of Tnseq traits

1. Infer allelic series at a CC clinical trait QTL  
1. Reduced scans of CC Tnseq traits over Bayes credible interval of the CC clinical QTL
1. Identify peaks for Tnseq traits
1. Permutation test to get p-values

---

# Reduced scans of Tnseq traits (lung CFU, Chr 17)

```{r}
t_out$cis_peaks[[1]] %>%
  dplyr::select(-c(ci_lo, ci_hi, lodindex)) %>%
  dplyr::rename(trait = lodcolumn) %>%
  dplyr::arrange(pvalue) %>%
  dplyr::filter(!stringr::str_starts(trait, "rv")) %>%
  dplyr::filter(pvalue < 0.05) %>%
  gt::gt() %>%
    gt::fmt_number(
    columns = dplyr::vars(lod, pos),
    decimals = 1
  )
```


???

Each CC clinical QTL has a table like this

---
class: inverse, center, middle

# References

